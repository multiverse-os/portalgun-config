# -*- mode: ruby -*-
# vi: set ft=ruby :

Portal.configure do |config|
  config.name = "rubydev"
  config.hostname = "rubydev"
  config.category = "multiverse"
  config.subcategory = "app"
  config.ephemeral = true

  config.cpus = 4 
  config.ram = 4096
  config.pinned_cpus = [1,3,5] 
  config.emulator = :qemu  
  config.arch = :x86_64
  config.chipset = :i440FX
  config.bios = :OVMF
  config.boot_order = [:vault] 
  config.add_device :sound do |device|
    device.model = "ICH9"
  end
  config.add_device :input do |device|
    device.input_type = "tablet"
  end 
  config.add_device :rng 


  config.spice do |spice|
    spice.address = "0.0.0.0"
    spice.port = 5900
    spice.tls = true
    spice.password = "test"
    spice.keymap = "en-us"
  end

  config.add_disk :vault do |disk|
    disk.size = 1024
    disk.read_only = false
    disk.serial = "x"
    disk.format = :ext4
    disk.bus = :virtio
    disk.cache = :none
    disk.io_mode = :native
    disk.discard = :ignore
    disk.detect_zeroes = :off
    disk.image = :qcow2
  end 

  config.ssh do |ssh|
    ssh.keys_only = true
    ssh.root_login = false 
    ssh.port = 22 
    ssh.keep_alive = true
  end

  config.os :debian do |os|
    os.release = :bullseye

    os.add_user :user do |user|
      user.authorized_keys = [
        "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG9ZZEPytQrgMDEHC641p1W/Wt84dG7Xte9meKbGUAk6 user@host"
      ]
      user.groups = ["kvm"]
      user.dot_configs do |dot|
        dot.edit :bashrc do |config|
          config.append("alias vim='nvim'")
          config.append("alias ls='ls -lah'")
          config.append("export GOPATH='/home/user/go'")
        end
        dot.edit :gitconfig do |git| 
          git.name = "Your Name"
          git.email = "you@example.com"
        end
      end
    end

    os.add_user :cool do |user|
      user.authorized_keys = [
        "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG9ZZEPytQrgMDEHC641p1W/Wt84dG7Xte9meKbGUAk6 user@host"
      ]
      user.groups = ["kvm"]
    end

    os.package_manager do |pm|
      pm.install = ["vim", "nvim"]
      pm.remove = ["nano"]
      pm.config.append('APT::Get::Install-Recommends "false";')
      pm.config.append('APT::Get::Install-Suggests   "false";')
      pm.repositories do |repositories|
        repositories.main = [
          "deb http://ftp.no.debian.org/debian/ bullseye main", 
          "deb-src http://ftp.no.debian.org/debian/ bullseye main"
        ]
        repositories.security = [
          "deb http://ftp.no.debian.org/debian-security buster/updates main",
          "deb-src http://ftp.no.debian.org/debian-security buster/updates main"
        ]
        repositories.updates = [
          "deb http://ftp.no.debian.org/debian/ buster-updates main",
          "deb-src http://ftp.no.debian.org/debian/ buster-updates main"
        ]
      end
    end

    os.filesystem do |fs|
      fs.rm("/home/user/Downloads")
      fs.rm("/home/user/Public")
      fs.rm("/home/user/Templates")
      fs.rm("/home/user/Pictures")
      fs.rm("/home/user/Documents")
      fs.rm("/home/user/Videos")
      fs.rm("/home/user/Music")
      fs.ln("/media/user/Downloads", "/home/user/Downloads")
      fs.mkdir("/home/user/go")

      fs.etc do |etc|
        etc.edit :resolvconf do |config|
          config.append("nameserver 212.82.226.212")
          config.append("nameserver 8.8.4.4")
        end
        
        etc.edit :issue do |config|
          config.overwrite("Multiverse OS App VM")
        end

        etc.edit :motd do |config|
          config.overwrite("[Debian 10 GNU/Linux]")
        end

        etc.edit :sysctl do |config|
          config.append("net.ipv4.conf.all.send_redirects = 0")
        end

        etc.edit :crontab do |config|
          config.append("25 6 * * * root test -x do something")
        end

        etc.edit :fstab do |config| 
          config.append("Downloads /media/user/Downloads 9p trans=virtio,9p2000.L,rw,cache=none,nofail 0 0")
        end
      end
    end

    os.kernel do |k| 
      k.modules = ["p9", "p9net", "p9net_virtio"]
    end

    os.install_configs do |config|
      config.repository = "github.com/multiverse-os/provisioning/app"
      config.install("/etc/hosts", "/etc/hosts")
    end

    os.add_network :virbr0 do |net|
      net.add_device :ens0 do |dev|
        dev.version = 4
        dev.mode = :static 
        dev.model = :virtio
        dev.address = "10.200.200.125"
        dev.dns = "8.8.4.4"
        dev.mac = "00:00:10:20:20:24"
      end
    end
  end

end
